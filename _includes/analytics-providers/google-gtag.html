<!-- Global site tag (gtag.js) - Google Analytics - Lazy loaded -->
<script>
  // 오류 처리 함수
  window.onerror = function(message, source, lineno, colno, error) {
    if (message.indexOf('CookieDeprecationLabel') > -1) {
      console.warn('Google Analytics encountered a cookie-related error, but the site will continue to function.');
      return true;
    }
  };

  // Google Analytics 로딩 함수
  function initGoogleAnalytics() {
    if (window.gaLoaded) return;
    window.gaLoaded = true;

    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    window.gtag = gtag;
    gtag('js', new Date());
    gtag('config', '{{ site.analytics.google.tracking_id }}', {
      'anonymize_ip': {{ site.analytics.google.anonymize_ip | default: false }},
      'cookie_flags': 'SameSite=None;Secure',
      'cookie_domain': 'auto',
      'allow_google_signals': false
    });

    // 스크립트 동적 로딩
    var script = document.createElement('script');
    script.src = "https://www.googletagmanager.com/gtag/js?id={{ site.analytics.google.tracking_id }}";
    script.async = true;
    document.head.appendChild(script);
  }

  // Load GA after page is interactive (non-blocking)
  if ('requestIdleCallback' in window) {
    requestIdleCallback(initGoogleAnalytics, { timeout: 2000 });
  } else {
    window.addEventListener('load', function() {
      setTimeout(initGoogleAnalytics, 500);
    });
  }
</script>